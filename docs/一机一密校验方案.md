# 一机一密校验方案

设备端获取信令链接地址时，需完成一机一密校验，接口文档地址：

<http://36.137.24.84.sslip.io:9988/business/doc.html#/robot-business-device/%E8%AE%BE%E5%A4%87%E9%93%BE%E6%8E%A5/getSignalUrl_3>


## 接口请求参数

| 参数名 | 必填 | 说明 |
|----|----|----|
| deviceId | 是 | 设备id，一般使用sn号 |
| macId | 是 | 设备mac地址 |
| ==sn== | 是 | 设备序列号 |
| ==cmei== | 是 | 设备cmei |
| deviceType | 是 | 设备类型(入库设备类型) |
| firmwareVersion | 是 | 设备固件版本 |
| softwareVersion | 否 | 设备软件版本 |
| sdkVersion | 否 | 设备sdk版本 |
| ==sign== | 是 | 签名 |
| ==timestamp== | 是 | 时间戳（与签名中的保持一致） |
| innerType | 是 | 内部类型 (1:单语音模块; 2:逗宠机器人; 3:服务机器人; 4:四足机器人; 5:轮式双臂; 6:双足机器人; 7:扫地机器人; 8:扩展类型) |
| extraParams | 否 | 其他url参数 |
| capabilityParams | 否 | 能力集参数 |


## 签名计算规则

1、拼接sn、cmei、timestamp（13位毫秒级时间戳）和snPwd（设备端持有），格式如下：

sn=xxx&cmei=xxx&timestamp=xxx&snPwd=xxx

2、使用==SHA-256加密==上述拼接字符串data，加密结果用==Base64编码==成字符串，作为请求参数sign：

* **MessageDigest digest = MessageDigest.getInstance("SHA-256");**
  * 获取 SHA-256 算法的 MessageDigest 实例，用于计算哈希值。
* **digest.update(data.getBytes(StandardCharsets.UTF_8));**
  * 将字符串 data 转换为 UTF-8 编码的字节数组，并更新到 MessageDigest 中，准备计算哈希。
* **digest.digest()**
  * 计算最终的哈希值，返回一个字节数组（长度为 32 字节，因为 SHA-256 的输出是 256 位）。
* **Base64.getEncoder().encodeToString(...)**
  * 将哈希值的字节数组用 Base64 编码，转换成可打印的字符串形式。


## 一机一密现网白名单

【腾讯文档】一机一密校验白名单 https://docs.qq.com/sheet/DVmppdGRQZWtGUmdE?tab=dr2k8n


\

## 一机一密对称加密

采用国密SM4算法。

密钥处理：SHA-256哈希，取前16字节 

SM4部分：使用ECB模式，无IV，减少计算开销


运营平台获取rtk账号接口文档 

<https://or44tsa8fz.feishu.cn/docx/IYJLdVS2PoButHxYJJycOT0SnRe>